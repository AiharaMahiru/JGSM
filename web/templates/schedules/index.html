{% extends "base.html" %}

{% block title %}课程表 - 学生管理系统{% endblock %}

{% block styles %}
<!-- 课程表专用样式 -->
<style>
    .schedule-container {
        width: 100%;
        overflow-x: auto;
    }
    
    .schedule-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
        min-width: 1000px;
    }
    
    .schedule-table th, .schedule-table td {
        border: 1px solid #dee2e6;
        padding: 8px;
        text-align: center;
        vertical-align: middle;
    }
    
    .schedule-table th {
        background-color: #f8f9fa;
        font-weight: 500;
    }
    
    .section-time {
        font-size: 0.8em;
        color: #6c757d;
    }
    
    .course-item {
        border-radius: 4px;
        padding: 5px;
        margin: 2px 0;
        font-size: 0.85rem;
        cursor: pointer;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }
    
    .course-name {
        font-weight: 500;
        margin-bottom: 3px;
    }
    
    .course-location {
        font-size: 0.75rem;
    }
    
    .course-week {
        font-size: 0.7rem;
        color: #6c757d;
    }
    
    /* 不同课程类型的颜色 */
    .week-type-0 { background-color: #d1ecf1; } /* 全部周 */
    .week-type-1 { background-color: #d4edda; } /* 单周 */
    .week-type-2 { background-color: #fff3cd; } /* 双周 */
    
    /* 鼠标悬停效果 */
    .course-item:hover {
        filter: brightness(0.95);
    }
    
    /* 按钮与选择器样式 */
    .schedule-controls {
        margin-bottom: 1rem;
    }
    
    .schedule-controls .form-control,
    .schedule-controls .btn {
        margin-right: 0.5rem;
    }
    
    .btn-add-course {
        position: fixed;
        bottom: 30px;
        right: 30px;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
    }
    
    /* 响应式调整 */
    @media (max-width: 768px) {
        .schedule-controls {
            flex-direction: column;
        }
        
        .schedule-controls .form-control,
        .schedule-controls .btn {
            margin-bottom: 0.5rem;
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header pb-0">
                    <h5>课程表</h5>
                    <p class="text-sm mb-0">
                        查看和管理课程安排，支持按学期、周次筛选，以及特殊课程（单双周）显示。
                    </p>
                </div>
                
                <div class="card-body">
                    <!-- 控制面板 -->
                    <div class="d-flex flex-wrap align-items-center mb-3 schedule-controls">
                        <!-- 学期选择 -->
                        <select id="semester-select" class="form-control" style="max-width: 180px;">
                            <option value="">加载中...</option>
                        </select>
                        
                        <!-- 周次选择 -->
                        <select id="week-select" class="form-control" style="max-width: 120px;">
                            <option value="">全部周</option>
                            {% for week in range(1, 21) %}
                            <option value="{{ week }}">第{{ week }}周</option>
                            {% endfor %}
                        </select>
                        
                        <!-- 单双周切换 -->
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary active" data-week-type="all">全部</button>
                            <button type="button" class="btn btn-outline-primary" data-week-type="1">单周</button>
                            <button type="button" class="btn btn-outline-primary" data-week-type="2">双周</button>
                        </div>
                        
                        <!-- 重置筛选 -->
                        <button id="reset-filters" class="btn btn-outline-secondary">
                            <i class="fas fa-sync-alt"></i> 重置筛选
                        </button>
                    </div>
                    
                    <!-- 提示信息 -->
                    <div id="schedule-message" class="alert alert-info d-none">
                        选择一个学期查看课程表
                    </div>
                    
                    <!-- 课程表容器 -->
                    <div class="schedule-container">
                        <table class="schedule-table" id="schedule-table">
                            <thead>
                                <tr>
                                    <th style="width: 60px;">节次</th>
                                    <th>星期一</th>
                                    <th>星期二</th>
                                    <th>星期三</th>
                                    <th>星期四</th>
                                    <th>星期五</th>
                                    <th>星期六</th>
                                    <th>星期日</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 课程表内容将通过JS动态生成 -->
                                <tr>
                                    <td colspan="8" class="text-center py-3">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">加载中...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加课程按钮 -->
<button type="button" class="btn btn-primary btn-add-course" id="btn-add-course" title="添加课程">
    <i class="fas fa-plus"></i>
</button>
<!-- 课程详情模态框 -->
<div class="modal fade" id="courseDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">课程详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="course-detail-container">
                    <div class="mb-3">
                        <strong>课程名称:</strong>
                        <span id="detail-course-name"></span>
                    </div>
                    <div class="mb-3">
                        <strong>课程编号:</strong>
                        <span id="detail-course-id"></span>
                    </div>
                    <div class="mb-3">
                        <strong>任课教师:</strong>
                        <span id="detail-teacher"></span>
                    </div>
                    <div class="mb-3">
                        <strong>上课地点:</strong>
                        <span id="detail-location"></span>
                    </div>
                    <div class="mb-3">
                        <strong>上课时间:</strong>
                        <span id="detail-time"></span>
                    </div>
                    <div class="mb-3">
                        <strong>上课周次:</strong>
                        <span id="detail-weeks"></span>
                    </div>
                    <div class="mb-3">
                        <strong>周类型:</strong>
                        <span id="detail-week-type"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="btn-edit-course">编辑</button>
                <button type="button" class="btn btn-danger" id="btn-delete-course">删除</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加/编辑课程模态框 -->
<div class="modal fade" id="editCourseModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="edit-modal-title">添加课程</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="course-form">
                    <input type="hidden" id="edit-schedule-id">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-course-id" class="form-label">课程 <span class="text-danger">*</span></label>
                            <select class="form-select" id="edit-course-id" required>
                                <option value="">选择课程</option>
                                <!-- 将通过AJAX加载课程列表 -->
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-semester" class="form-label">学期 <span class="text-danger">*</span></label>
                            <select class="form-select" id="edit-semester" required>
                                <option value="">选择学期</option>
                                <!-- 将通过AJAX加载学期列表 -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-day-of-week" class="form-label">星期几 <span class="text-danger">*</span></label>
                            <select class="form-select" id="edit-day-of-week" required>
                                <option value="">选择星期</option>
                                <option value="1">星期一</option>
                                <option value="2">星期二</option>
                                <option value="3">星期三</option>
                                <option value="4">星期四</option>
                                <option value="5">星期五</option>
                                <option value="6">星期六</option>
                                <option value="7">星期日</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-location" class="form-label">教室位置 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit-location" placeholder="如: A栋201" required>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">节次 <span class="text-danger">*</span></label>
                            <div class="d-flex">
                                <select class="form-select me-2" id="edit-start-section" required>
                                    <option value="">开始节</option>
                                    {% for i in range(1, 12) %}
                                    <option value="{{ i }}">第{{ i }}节</option>
                                    {% endfor %}
                                </select>
                                <span class="align-self-center">至</span>
                                <select class="form-select ms-2" id="edit-end-section" required>
                                    <option value="">结束节</option>
                                    {% for i in range(1, 12) %}
                                    <option value="{{ i }}">第{{ i }}节</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">周次 <span class="text-danger">*</span></label>
                            <div class="d-flex">
                                <select class="form-select me-2" id="edit-start-week" required>
                                    <option value="">开始周</option>
                                    {% for i in range(1, 21) %}
                                    <option value="{{ i }}">第{{ i }}周</option>
                                    {% endfor %}
                                </select>
                                <span class="align-self-center">至</span>
                                <select class="form-select ms-2" id="edit-end-week" required>
                                    <option value="">结束周</option>
                                    {% for i in range(1, 21) %}
                                    <option value="{{ i }}">第{{ i }}周</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="edit-week-type" class="form-label">周类型</label>
                            <select class="form-select" id="edit-week-type">
                                <option value="0">全部周</option>
                                <option value="1">单周</option>
                                <option value="2">双周</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="edit-teacher" class="form-label">任课教师</label>
                            <input type="text" class="form-control" id="edit-teacher" placeholder="可选">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" id="btn-save-course">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 删除确认模态框 -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>确定要删除此课程安排吗？此操作不可恢复。</p>
                <p id="delete-course-info" class="text-danger"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" id="btn-confirm-delete">确认删除</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 当前课程表数据
    let scheduleData = null;
    // 当前选中的课程表项ID（用于编辑/删除）
    let currentScheduleId = null;
    // 周类型筛选
    let weekTypeFilter = 'all';
    // 可用的课程列表
    let availableCourses = [];
    // 可用的学期列表
    let availableSemesters = [];
    
    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        console.log("DOM已加载，开始初始化页面");
        // 初始化
        initSchedulePage();
        
        // 绑定事件监听器
        bindEventListeners();
    });
    
    // 初始化课程表页面
    function initSchedulePage() {
        console.log("初始化课程表页面");
        // 显示加载提示
        showMessage('正在加载学期数据...', 'info');
        
        // 加载学期列表
        console.log("开始加载学期列表");
        loadSemesters()
            .then(() => {
                console.log("学期列表加载完成，可用学期:", availableSemesters);
                // 如果有可用学期，选择第一个学期并加载课程表
                if (availableSemesters.length > 0) {
                    console.log("选择第一个学期:", availableSemesters[0]);
                    document.getElementById('semester-select').value = availableSemesters[0];
                    loadScheduleData(availableSemesters[0]);
                } else {
                    console.warn("没有可用的学期数据");
                    showMessage('没有可用的学期数据', 'warning');
                }
            })
            .catch(error => {
                console.error('加载学期列表失败:', error);
                showMessage('加载学期列表失败: ' + error.message, 'danger');
            });
        
        // 加载课程列表（用于添加/编辑课程）
        console.log("开始加载课程列表");
        loadCourses();
    }
    
    // 绑定事件监听器
    function bindEventListeners() {
        // 学期选择变化
        document.getElementById('semester-select').addEventListener('change', function() {
            const semester = this.value;
            if (semester) {
                loadScheduleData(semester);
            } else {
                showMessage('请选择学期', 'info');
                clearScheduleTable();
            }
        });
        
        // 周次选择变化
        document.getElementById('week-select').addEventListener('change', function() {
            const week = this.value;
            const semester = document.getElementById('semester-select').value;
            
            if (semester) {
                if (week) {
                    loadScheduleData(semester, week);
                } else {
                    loadScheduleData(semester);
                }
            }
        });
        
        // 单双周切换
        document.querySelectorAll('[data-week-type]').forEach(button => {
            button.addEventListener('click', function() {
                // 更新按钮状态
                document.querySelectorAll('[data-week-type]').forEach(btn => {
                    btn.classList.remove('active');
                });
                this.classList.add('active');
                
                // 更新过滤器
                weekTypeFilter = this.dataset.weekType;
                
                // 应用过滤器
                applyWeekTypeFilter();
            });
        });
        
        // 重置筛选按钮
        document.getElementById('reset-filters').addEventListener('click', function() {
            // 重置周次选择
            document.getElementById('week-select').value = '';
            
            // 重置单双周按钮
            document.querySelectorAll('[data-week-type]').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('[data-week-type="all"]').classList.add('active');
            weekTypeFilter = 'all';
            
            // 重新加载当前学期的课程表
            const semester = document.getElementById('semester-select').value;
            if (semester) {
                loadScheduleData(semester);
            }
        });
        
        // 添加课程按钮
        document.getElementById('btn-add-course').addEventListener('click', function() {
            openAddCourseModal();
        });
        
        // 保存课程按钮
        document.getElementById('btn-save-course').addEventListener('click', function() {
            saveScheduleItem();
        });
        
        // 编辑课程按钮
        document.getElementById('btn-edit-course').addEventListener('click', function() {
            if (currentScheduleId) {
                // 打开编辑模态框
                openEditCourseModal(currentScheduleId);
                // 关闭详情模态框
                bootstrap.Modal.getInstance(document.getElementById('courseDetailModal')).hide();
            }
        });
        
        // 删除课程按钮
        document.getElementById('btn-delete-course').addEventListener('click', function() {
            if (currentScheduleId) {
                // 显示删除确认信息
                const courseInfo = document.getElementById('detail-course-name').textContent;
                const location = document.getElementById('detail-location').textContent;
                const time = document.getElementById('detail-time').textContent;
                
                document.getElementById('delete-course-info').textContent = 
                    `课程: ${courseInfo}, 地点: ${location}, 时间: ${time}`;
                
                // 打开删除确认模态框
                new bootstrap.Modal(document.getElementById('deleteConfirmModal')).show();
                
                // 关闭详情模态框
                bootstrap.Modal.getInstance(document.getElementById('courseDetailModal')).hide();
            }
        });
        
        // 确认删除按钮
        document.getElementById('btn-confirm-delete').addEventListener('click', function() {
            if (currentScheduleId) {
                deleteScheduleItem(currentScheduleId);
            }
        });
    }
    
    // 加载学期列表
    async function loadSemesters() {
        try {
            console.log("发送请求获取学期列表...");
            console.log("完整请求URL:", window.location.origin + '/api/schedules/semesters');
            
            const response = await fetch('/api/schedules/semesters');
            console.log("学期列表API响应状态:", response.status);
            console.log("学期列表API响应头:", Object.fromEntries([...response.headers]));
            
            if (!response.ok) {
                console.error(`HTTP错误! 状态: ${response.status} ${response.statusText}`);
                const errorText = await response.text();
                console.error("错误响应内容:", errorText);
                throw new Error(`HTTP错误! 状态: ${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log("学期列表API响应数据:", result);
            
            if (result.success) {
                availableSemesters = result.data;
                console.log("获取到学期列表:", availableSemesters);
                
                // 更新学期选择器
                const semesterSelect = document.getElementById('semester-select');
                semesterSelect.innerHTML = '';
                
                if (availableSemesters.length === 0) {
                    console.warn("学期列表为空");
                    semesterSelect.innerHTML = '<option value="">暂无学期数据</option>';
                } else {
                    availableSemesters.forEach(semester => {
                        const option = document.createElement('option');
                        option.value = semester;
                        option.textContent = formatSemester(semester);
                        semesterSelect.appendChild(option);
                    });
                    console.log("学期选择器更新完成");
                }
                
                // 同时更新编辑模态框中的学期选择器
                const editSemesterSelect = document.getElementById('edit-semester');
                editSemesterSelect.innerHTML = '<option value="">选择学期</option>';
                
                availableSemesters.forEach(semester => {
                    const option = document.createElement('option');
                    option.value = semester;
                    option.textContent = formatSemester(semester);
                    editSemesterSelect.appendChild(option);
                });
                console.log("编辑模态框学期选择器更新完成");
            } else {
                console.error('获取学期列表失败:', result.message);
                showMessage('获取学期列表失败: ' + result.message, 'danger');
            }
        } catch (error) {
            console.error('获取学期列表异常:', error);
            console.error('错误堆栈:', error.stack);
            showMessage('获取学期列表异常: ' + error.message, 'danger');
            throw error;
        }
    }
    
    // 加载课程列表
    async function loadCourses() {
        try {
            const response = await fetch('/api/courses');
            const result = await response.json();
            
            if (result.success) {
                availableCourses = result.data.items;
                
                // 更新课程选择器
                const courseSelect = document.getElementById('edit-course-id');
                courseSelect.innerHTML = '<option value="">选择课程</option>';
                
                availableCourses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.course_id;
                    option.textContent = `${course.course_name} (${course.course_id})`;
                    courseSelect.appendChild(option);
                });
            } else {
                console.error('获取课程列表失败:', result.message);
                showMessage('获取课程列表失败: ' + result.message, 'danger');
            }
        } catch (error) {
            console.error('获取课程列表异常:', error);
            showMessage('获取课程列表异常: ' + error.message, 'danger');
        }
    }
    
    // 加载课程表数据
    async function loadScheduleData(semester, week = null) {
        try {
            console.log(`开始加载课程表数据, 学期: ${semester}, 周次: ${week || '全部'}`);
            
            // 显示加载提示
            clearScheduleTable();
            const tableBody = document.querySelector('#schedule-table tbody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">加载中...</span>
                        </div>
                    </td>
                </tr>
            `;
            console.log("加载中状态已显示");
            
            // 构建API URL
            let url = `/api/schedules?semester=${encodeURIComponent(semester)}`;
            if (week) {
                url += `&week=${week}`;
            }
            console.log("API请求URL:", url);
            console.log("完整请求URL:", window.location.origin + url);
            
            // 发送请求
            console.log("发送课程表数据请求...");
            const response = await fetch(url);
            console.log("课程表API响应状态:", response.status);
            console.log("课程表API响应头:", Object.fromEntries([...response.headers]));
            
            if (!response.ok) {
                console.error(`HTTP错误! 状态: ${response.status} ${response.statusText}`);
                const errorText = await response.text();
                console.error("错误响应内容:", errorText);
                throw new Error(`HTTP错误! 状态: ${response.status} ${response.statusText}`);
            }
            
            const result = await response.json();
            console.log("课程表API响应数据:", result);
            
            if (result.success) {
                // 保存课程表数据
                scheduleData = result.data;
                console.log("获取到课程表数据:", scheduleData);
                
                // 渲染课程表
                console.log("开始渲染课程表");
                renderScheduleTable(scheduleData);
                console.log("课程表渲染完成");
                
                // 应用周类型过滤器
                applyWeekTypeFilter();
                console.log("周类型过滤器已应用");
                
                // 隐藏提示信息
                hideMessage();
                console.log("提示信息已隐藏");
            } else {
                console.error('获取课程表失败:', result.message);
                showMessage('获取课程表失败: ' + result.message, 'warning');
            }
        } catch (error) {
            console.error('获取课程表异常:', error);
            console.error('错误堆栈:', error.stack);
            showMessage('获取课程表异常: ' + error.message, 'danger');
            // 清除加载中状态，显示错误信息
            const tableBody = document.querySelector('#schedule-table tbody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-3 text-danger">
                        加载失败: ${error.message}
                    </td>
                </tr>
            `;
        }
    }
    
    // 渲染课程表
    function renderScheduleTable(data) {
        console.log("渲染课程表开始, 数据:", data);
        
        try {
            if (!data || !data.sections || !data.days) {
                console.error("课程表数据格式错误:", data);
                showMessage("课程表数据格式错误", "danger");
                return;
            }
            
            const sections = data.sections;
            const days = data.days;
            
            console.log(`渲染课程表: ${sections.length}个节次, 7天数据`);
            
            // 创建表格内容
            const tableBody = document.querySelector('#schedule-table tbody');
            tableBody.innerHTML = '';
            
            // 根据节次生成行
            sections.forEach(section => {
                const row = document.createElement('tr');
                
                // 第一列：节次和时间
                const sectionCell = document.createElement('td');
                sectionCell.innerHTML = `
                    <div class="section-number">${section.number}</div>
                    <div class="section-time">${section.start_time}-${section.end_time}</div>
                `;
                row.appendChild(sectionCell);
                
                // 每天的课程列
                for (let day = 1; day <= 7; day++) {
                    try {
                        const cell = document.createElement('td');
                        
                        // 确保天数据存在
                        if (!days[day] || !Array.isArray(days[day])) {
                            console.warn(`第${day}天数据不存在或不是数组`);
                            row.appendChild(cell);
                            continue;
                        }
                        
                        // 获取当前节次当前天的所有课程
                        const courses = days[day].filter(course =>
                            course.start_section <= section.number &&
                            course.end_section >= section.number
                        );
                        
                        console.log(`第${day}天第${section.number}节: 找到${courses.length}个课程`);
                        
                        // 如果有课程，显示课程信息
                        if (courses.length > 0) {
                            // 根据课程持续节数设置行高
                            if (courses[0].start_section === section.number) {
                                cell.setAttribute('rowspan', courses[0].section_span);
                                
                                // 创建课程项
                                courses.forEach(course => {
                                    const courseElem = createCourseElement(course);
                                    cell.appendChild(courseElem);
                                });
                            } else {
                                // 如果是已经被上一行占用的节次，则不显示此单元格
                                continue;
                            }
                        }
                        
                        row.appendChild(cell);
                    } catch (dayError) {
                        console.error(`处理第${day}天数据时出错:`, dayError);
                        const errorCell = document.createElement('td');
                        errorCell.className = "text-danger";
                        errorCell.textContent = "数据错误";
                        row.appendChild(errorCell);
                    }
                }
                
                tableBody.appendChild(row);
            });
            
            console.log("课程表渲染完成");
        } catch (renderError) {
            console.error("渲染课程表时发生错误:", renderError);
            const tableBody = document.querySelector('#schedule-table tbody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-3 text-danger">
                        渲染课程表失败: ${renderError.message}
                    </td>
                </tr>
            `;
        }
    }
    
    // 创建课程元素
    function createCourseElement(course) {
        const courseElem = document.createElement('div');
        courseElem.className = `course-item week-type-${course.week_type}`;
        courseElem.dataset.id = course.id;
        
        // 设置周类型数据属性
        courseElem.dataset.weekType = course.week_type;
        
        // 显示课程信息
        courseElem.innerHTML = `
            <div class="course-name">${course.course_name}</div>
            <div class="course-location">${course.location}</div>
            <div class="course-week">${formatWeekInfo(course)}</div>
        `;
        
        // 添加点击事件
        courseElem.addEventListener('click', function() {
            showCourseDetail(course);
        });
        
        return courseElem;
    }
    
    // 显示课程详情
    function showCourseDetail(course) {
        currentScheduleId = course.id;
        
        // 设置详情模态框内容
        document.getElementById('detail-course-name').textContent = course.course_name;
        document.getElementById('detail-course-id').textContent = course.course_id;
        document.getElementById('detail-teacher').textContent = course.teacher || '未指定';
        document.getElementById('detail-location').textContent = course.location;
        
        // 设置上课时间
        const dayNames = ['', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六', '星期日'];
        document.getElementById('detail-time').textContent = 
            `${dayNames[course.day_of_week]} 第${course.start_section}-${course.end_section}节 (${course.start_time}-${course.end_time})`;
        
        // 设置周次
        document.getElementById('detail-weeks').textContent = 
            `第${course.start_week}-${course.end_week}周`;
        
        // 设置周类型
        const weekTypes = {'0': '全部周', '1': '单周', '2': '双周'};
        document.getElementById('detail-week-type').textContent = weekTypes[course.week_type];
        
        // 显示模态框
        new bootstrap.Modal(document.getElementById('courseDetailModal')).show();
    }
    
    // 打开添加课程模态框
    function openAddCourseModal() {
        // 重置表单
        document.getElementById('course-form').reset();
        document.getElementById('edit-schedule-id').value = '';
        document.getElementById('edit-modal-title').textContent = '添加课程';
        
        // 预设当前学期
        const currentSemester = document.getElementById('semester-select').value;
        if (currentSemester) {
            document.getElementById('edit-semester').value = currentSemester;
        }
        
        // 预设默认值
        document.getElementById('edit-week-type').value = '0'; // 默认全部周
        
        // 显示模态框
        new bootstrap.Modal(document.getElementById('editCourseModal')).show();
    }
    
    // 打开编辑课程模态框
    async function openEditCourseModal(scheduleId) {
        try {
            // 显示加载中
            document.getElementById('edit-modal-title').textContent = '编辑课程';
            document.getElementById('course-form').reset();
            
            // 获取课程表项详情
            const response = await fetch(`/api/schedules/${scheduleId}`);
            const result = await response.json();
            
            if (result.success) {
                const scheduleItem = result.data;
                
                // 填充表单
                document.getElementById('edit-schedule-id').value = scheduleItem.id;
                document.getElementById('edit-course-id').value = scheduleItem.course_id;
                document.getElementById('edit-semester').value = scheduleItem.semester;
                document.getElementById('edit-day-of-week').value = scheduleItem.day_of_week;
                document.getElementById('edit-location').value = scheduleItem.location;
                document.getElementById('edit-start-section').value = scheduleItem.start_section;
                document.getElementById('edit-end-section').value = scheduleItem.end_section;
                document.getElementById('edit-start-week').value = scheduleItem.start_week;
                document.getElementById('edit-end-week').value = scheduleItem.end_week;
                document.getElementById('edit-week-type').value = scheduleItem.week_type;
                document.getElementById('edit-teacher').value = scheduleItem.teacher || '';
                
                // 显示模态框
                new bootstrap.Modal(document.getElementById('editCourseModal')).show();
            } else {
                console.error('获取课程表项详情失败:', result.message);
                showToast('获取课程表项详情失败: ' + result.message, 'danger');
            }
        } catch (error) {
            console.error('获取课程表项详情异常:', error);
            showToast('获取课程表项详情异常: ' + error.message, 'danger');
        }
    }
    
    // 保存课程表项
    async function saveScheduleItem() {
        try {
            // 获取表单数据
            const scheduleData = {
                course_id: document.getElementById('edit-course-id').value,
                semester: document.getElementById('edit-semester').value,
                day_of_week: parseInt(document.getElementById('edit-day-of-week').value),
                location: document.getElementById('edit-location').value,
                start_section: parseInt(document.getElementById('edit-start-section').value),
                end_section: parseInt(document.getElementById('edit-end-section').value),
                start_week: parseInt(document.getElementById('edit-start-week').value),
                end_week: parseInt(document.getElementById('edit-end-week').value),
                week_type: parseInt(document.getElementById('edit-week-type').value),
                teacher: document.getElementById('edit-teacher').value
            };
            
            // 验证必填字段
            const requiredFields = ['course_id', 'semester', 'day_of_week', 'location', 
                                   'start_section', 'end_section', 'start_week', 'end_week'];
            
            for (const field of requiredFields) {
                if (!scheduleData[field]) {
                    showToast('请填写所有必填字段', 'warning');
                    return;
                }
            }
            
            // 验证节次和周次
            if (scheduleData.start_section > scheduleData.end_section) {
                showToast('开始节次不能大于结束节次', 'warning');
                return;
            }
            
            if (scheduleData.start_week > scheduleData.end_week) {
                showToast('开始周次不能大于结束周次', 'warning');
                return;
            }
            
            // 设置请求URL和方法
            const scheduleId = document.getElementById('edit-schedule-id').value;
            let url = '/api/schedules';
            let method = 'POST';
            
            if (scheduleId) {
                // 编辑现有课程
                url += `/${scheduleId}`;
                method = 'PUT';
            }
            
            // 发送请求
            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(scheduleData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                // 关闭模态框
                bootstrap.Modal.getInstance(document.getElementById('editCourseModal')).hide();
                
                // 显示成功提示
                showToast('课程安排保存成功', 'success');
                
                // 重新加载课程表
                loadScheduleData(document.getElementById('semester-select').value);
            } else {
                console.error('保存课程表项失败:', result.message);
                showToast('保存失败: ' + result.message, 'danger');
            }
        } catch (error) {
            console.error('保存课程表项异常:', error);
            showToast('保存异常: ' + error.message, 'danger');
        }
    }
    
    // 删除课程表项
    async function deleteScheduleItem(scheduleId) {
        try {
            // 发送删除请求
            const response = await fetch(`/api/schedules/${scheduleId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                // 关闭确认模态框
                bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal')).hide();
                
                // 显示成功提示
                showToast('课程安排已删除', 'success');
                
                // 重新加载课程表
                loadScheduleData(document.getElementById('semester-select').value);
            } else {
                console.error('删除课程表项失败:', result.message);
                showToast('删除失败: ' + result.message, 'danger');
            }
        } catch (error) {
            console.error('删除课程表项异常:', error);
            showToast('删除异常: ' + error.message, 'danger');
        }
    }
    
    // 应用周类型过滤器
    function applyWeekTypeFilter() {
        if (!scheduleData) return;
        
        // 获取所有课程项
        const courseItems = document.querySelectorAll('.course-item');
        
        courseItems.forEach(item => {
            if (weekTypeFilter === 'all') {
                // 显示所有课程
                item.style.display = '';
            } else {
                // 仅显示匹配周类型的课程
                const weekType = item.dataset.weekType;
                item.style.display = (weekType === '0' || weekType === weekTypeFilter) ? '' : 'none';
            }
        });
    }
    
    // 清空课程表
    function clearScheduleTable() {
        const tableBody = document.querySelector('#schedule-table tbody');
        tableBody.innerHTML = '';
    }
    
    // 显示消息
    function showMessage(message, type = 'info') {
        const messageElem = document.getElementById('schedule-message');
        messageElem.textContent = message;
        messageElem.className = `alert alert-${type}`;
        messageElem.classList.remove('d-none');
    }
    
    // 隐藏消息
    function hideMessage() {
        const messageElem = document.getElementById('schedule-message');
        messageElem.classList.add('d-none');
    }
    
    // 显示浮动提示
    function showToast(message, type = 'info') {
        // 创建提示元素
        const toastContainer = document.createElement('div');
        toastContainer.className = 'position-fixed top-0 end-0 p-3';
        toastContainer.style.zIndex = '9999';
        
        const toastElement = document.createElement('div');
        toastElement.className = `toast align-items-center text-white bg-${type} border-0`;
        toastElement.setAttribute('role', 'alert');
        toastElement.setAttribute('aria-live', 'assertive');
        toastElement.setAttribute('aria-atomic', 'true');
        
        toastElement.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
        `;
        
        toastContainer.appendChild(toastElement);
        document.body.appendChild(toastContainer);
        
        // 显示提示
        const toast = new bootstrap.Toast(toastElement, {
            delay: 3000
        });
        toast.show();
        
        // 提示关闭后移除元素
        toastElement.addEventListener('hidden.bs.toast', function() {
            document.body.removeChild(toastContainer);
        });
    }
    
    // 格式化学期显示
    function formatSemester(semester) {
        // 假设格式为 "2024-2025-1"，表示2024-2025学年第1学期
        const parts = semester.split('-');
        if (parts.length === 3) {
            return `${parts[0]}-${parts[1]}学年 第${parts[2]}学期`;
        }
        return semester;
    }
    
    // 格式化周次信息显示
    function formatWeekInfo(course) {
        let weekInfo = `${course.start_week}-${course.end_week}周`;
        
        // 添加单双周标记
        if (course.week_type === 1) {
            weekInfo += ' (单)';
        } else if (course.week_type === 2) {
            weekInfo += ' (双)';
        }
        
        return weekInfo;
    }
</script>
{% endblock %}